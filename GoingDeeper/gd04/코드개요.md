# 코드 안내

## 전체 개요

---

## 1. 코드 구조 분석

### 1.1 디렉토리 구조
```
detec/
├── face_detector/
│   ├── dataset.py       # 데이터셋 로딩 및 증강
│   ├── model.py         # SSD 모델 정의
│   └── utils.py         # Loss, Scheduler, Encoding
├── train.py             # 학습 스크립트
├── inference.py         # 단일 이미지 추론
├── realtime.py          # 실시간 웹캠 추론
├── widerface/           # 데이터셋
├── test_result/         # 테스트 결과
├── checkpoints/         # 체크포인트
├── checkpoints_noaug/   # 증강 없음
├── checkpoints_small_aug/   # 증강 있음
├── checkpoints_hardaug/   # 증강 있음
└── checkpoints_strongest_aug/   # 증강 있음
└── README.md            # 코드 설명

```



---

## 2. 아키텍처 

### 2.1 데이터 흐름

```
Raw Image (다양한 크기)
    ↓
[Dataset.__getitem__]
    ├─ _process_image (PIL 로드)
    ├─ _crop (랜덤 크롭)
    ├─ _pad_to_square (정사각형 패딩)
    ├─ _resize (320x256)
    ├─ _flip (50% 확률)
    ├─ _distort / _blur / _noise / _erasing (증강)
    └─ encode_pt (GT 인코딩)
    ↓
Batch (64, 3, 256, 320)
    ↓
[SSD Model]
    ├─ Features (stride 8, 16, 32, 64)
    └─ Heads (loc + class)
    ↓
[MultiBoxLoss]
    ├─ Smooth L1 Loss
    └─ Cross Entropy + Hard Negative Mining
    ↓
Backward + Optimization
```

---

## 3. 버그 및 수정 이력

### 3.1 Critical Bugs (모두 수정)

| 버그 | 발견일 | 수정일 | 상태 |
|------|--------|--------|------|
| tkinter 스레딩 오류 | 2025-11-23 | 2025-11-23 | ✅ |
| Loss 너무 높음 (17-20) | 이전 | 이전 | ✅ |
| _pad_to_square bbox 미업데이트 | 이전 | 이전 | ✅ |
| n_object==0 파싱 오류 | 이전 | 이전 | ✅ |
| Inference bbox clipping | 이전 | 이전 | ✅ |
| encode_pt format 불일치 | 이전 | 이전 | ✅ |

### 3.2 최근 개선사항 (2025-11-23)

**1) 증강 강도 대폭 증가**
```python
# 이전: 70% 증강 적용
# 현재: 95% 증강 적용
- Color distortion: 80% (skip 20%)
- Blur: 25%
- Noise: 25%
- Erasing: 25%
```

**2) matplotlib 백엔드 수정**
```python
matplotlib.use('Agg')  # GUI 백엔드 tkinter 문제 해결
```

**3) persistent_workers 제거**
```python
# Windows에서 cv2와 충돌 방지
```


