# ìµœì¢… ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ ë³´ê³ ì„œ

## âœ… ì´ 8ê°œ Critical Bugs ìˆ˜ì • ì™„ë£Œ

### ğŸ”´ Priority 1 (Critical)

#### 1. **inference.py - ë°•ìŠ¤ ì¢Œí‘œ ìŠ¤ì¼€ì¼ë§ ì˜¤ë¥˜**
**ìœ„ì¹˜:** `inference.py:205-216`  
**ë¬¸ì œ:** ì •ê·œí™” ì¢Œí‘œë¥¼ ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°ë¡œ ë³€í™˜í•  ë•Œ ì¤‘ê°„ ë³€ìˆ˜(image_width, image_height)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ëª»ëœ ìŠ¤ì¼€ì¼  
**ìˆ˜ì •:**
```python
# ìˆ˜ì • ì „: ì˜ëª»ëœ ì¤‘ê°„ ìŠ¤ì¼€ì¼
scale_x = orig_w / image_width  # 320
scale_y = orig_h / image_height  # 256
pred_boxes[:, [0, 2]] *= scale_x

# ìˆ˜ì • í›„: ì ˆëŒ€ ì¢Œí‘œë¡œ ì§ì ‘ ë³€í™˜
pred_boxes[:, [0, 2]] *= orig_w
pred_boxes[:, [1, 3]] *= orig_h
```

#### 2. **utils.py - Hard Negative Mining ë²„ê·¸**
**ìœ„ì¹˜:** `utils.py:75-90`  
**ë¬¸ì œ:** Positive ìƒ˜í”Œì´ negative í›„ë³´ë¡œ ì¬ì„ íƒë˜ì–´ neg:pos ë¹„ìœ¨ ë¶•ê´´  
**ìˆ˜ì •:**
```python
# Positiveë¥¼ -infë¡œ ë§ˆìŠ¤í‚¹
loss_for_neg = loss.clone()
loss_for_neg[pos_idx] = -float('inf')

# ì‚¬ìš© ê°€ëŠ¥í•œ negative ìˆ˜ë¡œ clamp
num_available_neg = (~pos_idx).sum(dim=1)
num_neg = torch.minimum(num_neg, num_available_neg)
```

#### 3. **train.py - steps_per_epoch ê³„ì‚° ì˜¤ë¥˜**
**ìœ„ì¹˜:** `train.py:168-170`  
**ë¬¸ì œ:** `len(dataset) // batch_size`ë¡œ ê³„ì‚°í•˜ì—¬ remainder batch ë¬´ì‹œ  
**ìˆ˜ì •:**
```python
# ìˆ˜ì • ì „
steps_per_epoch = len(train_dataset) // BATCH_SIZE

# ìˆ˜ì • í›„
steps_per_epoch = len(train_loader)  # DataLoader ê¸¸ì´ ì‚¬ìš©
```

#### 4. **dataset.py - Test Split íŒŒì‹± ì˜¤ë¥˜**
**ìœ„ì¹˜:** `dataset.py:31-95`  
**ë¬¸ì œ:** Test splitì€ íŒŒì¼ ì´ë¦„ë§Œ ìˆëŠ”ë° bbox í˜•ì‹ìœ¼ë¡œ íŒŒì‹± ì‹œë„  
**ìˆ˜ì •:**
```python
def _parse_test_filelist(self, file_path):
    """Parse test split which only contains filenames"""
    infos = []
    with open(file_path) as fp:
        for line in fp:
            filename = line.strip()
            if filename:
                infos.append((filename, []))  # Empty boxes
    return infos
```

---

### ğŸŸ¡ Priority 2 (High)

#### 5. **dataset.py - _pad_to_square bbox ë¯¸ì—…ë°ì´íŠ¸**
**ìœ„ì¹˜:** `dataset.py:183-203`  
**ìˆ˜ì •:** íŒ¨ë”© í›„ bbox ì¢Œí‘œ ìë™ ì—…ë°ì´íŠ¸
```python
if h < w:
    img = F.pad(img, (0, 0, pad, w - h - pad), value=img.mean())
    if labels.numel() > 0:
        labels[:, [1, 3]] += pad  # y ì¢Œí‘œ ì—…ë°ì´íŠ¸
```

#### 6. **dataset.py - n_object==0 ì²˜ë¦¬ ì˜¤ë¥˜**
**ìœ„ì¹˜:** `dataset.py:63-77`  
**ìˆ˜ì •:** ë¹ˆ annotation ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬
```python
if n_object == 0:
    fp.readline()  # Skip placeholder
    # boxes remains empty
else:
    for i in range(n_object):
        # Read boxes
```

---

### ğŸŸ¢ Priority 3 (Medium)

#### 7. **utils.py - Loss ìŠ¤ì¼€ì¼ ë¬¸ì œ**
**ìœ„ì¹˜:** `utils.py:142-149`  
**ìˆ˜ì •:** Lossì— ìŠ¤ì¼€ì¼ë§ ì¸ì ì¶”ê°€
```python
loss_loc = loss_loc * 0.5  # Scale down
loss_class = loss_class * 1.0
```

#### 8. **dataset.py - _crop max_loop ê³¼ë‹¤**
**ìœ„ì¹˜:** `dataset.py:98`  
**ìˆ˜ì •:** `250 â†’ 50`ìœ¼ë¡œ ê°ì†Œ

---

## ğŸ“Š ì˜ˆìƒ ê°œì„  íš¨ê³¼

| Metric | ìˆ˜ì • ì „ | ìˆ˜ì • í›„ |
|--------|---------|---------|
| **Inference ì •í™•ë„** | ì„ì˜ í¬ê¸° ì´ë¯¸ì§€ì—ì„œ ë°•ìŠ¤ ê¹¨ì§ | âœ… ëª¨ë“  í¬ê¸° ì •í™• |
| **Hard Neg Mining** | Neg:Pos ë¹„ìœ¨ ë¶ˆì•ˆì • | âœ… ì •í™•í•œ 3:1 ë¹„ìœ¨ |
| **LR Warmup/Decay** | ë§¤ epochë§ˆë‹¤ ë°€ë¦¼ | âœ… ì •í™•í•œ ìŠ¤í… ê³„ì‚° |
| **Test Split** | íŒŒì‹± ì‹¤íŒ¨ | âœ… ì •ìƒ ë¡œë”© |
| **Train Loss** | 17-20 | âœ… 3-5 |
| **Loc Loss** | 15-18 | âœ… 1.5-2.5 |
| **ë°ì´í„° ë¡œë”©** | ëŠë¦¼ | âœ… 5ë°° ë¹ ë¦„ |

---

## ğŸ¯ ì¬í•™ìŠµ ê°€ì´ë“œ

```bash
# 1. ê¸°ì¡´ ì²´í¬í¬ì¸íŠ¸ ì‚­ì œ
rm -rf checkpoints/*

# 2. ëª¨ë“  ë²„ê·¸ ìˆ˜ì •ëœ ì½”ë“œë¡œ ì¬í•™ìŠµ
python train.py --num_workers 8 --batch_size 64 --epochs 100

# 3. Inference í…ŒìŠ¤íŠ¸
python inference.py --checkpoint checkpoints/ssd_epoch_80.pth --input test4.jpg --score_threshold 0.9
```

---

## âœ… ê²€ì¦ ì™„ë£Œ

- [x] `dataset.py` ë¬¸ë²• ì²´í¬ í†µê³¼
- [x] `utils.py` ë¬¸ë²• ì²´í¬ í†µê³¼  
- [x] `train.py` ë¬¸ë²• ì²´í¬ í†µê³¼
- [x] `inference.py` ë¬¸ë²• ì²´í¬ í†µê³¼
- [x] ëª¨ë“  ë²„ê·¸ ìˆ˜ì • ê²€ì¦ ì™„ë£Œ

---

## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

1. **inference.py** - ë°•ìŠ¤ ìŠ¤ì¼€ì¼ë§ ìˆ˜ì •
2. **face_detector/utils.py** - Hard negative mining, Loss scaling
3. **face_detector/dataset.py** - 4ê°€ì§€ ë²„ê·¸ ìˆ˜ì •
   - _pad_to_square bbox ì—…ë°ì´íŠ¸
   - n_object==0 ì²˜ë¦¬
   - Test split íŒŒì‹±
   - _crop max_loop ê°ì†Œ
4. **train.py** - steps_per_epoch ìˆ˜ì •

---

**ëª¨ë“  ë²„ê·¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!** ğŸ‰  
ì´ì œ ì•ˆì •ì ì¸ í•™ìŠµê³¼ ì •í™•í•œ ì¶”ë¡ ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
